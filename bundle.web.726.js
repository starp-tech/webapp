(()=>{"use strict";var e={67726:(e,r,t)=>{t.r(r);var o=t(62214),a=t(93883),n=t(90668),s=t(55901),c=t(60377),i=t(81576),l=t(80870),u=t(73366),d=t(18473),p=t(475),g=t(53402),f=t(21575),y=t(41781),b=t(19933);globalThis.sqlite3Worker1Promiser=function e(r=e.defaultConfig){if(1===arguments.length&&"function"===typeof arguments[0]){const t=r;(r=Object.assign(Object.create(null),e.defaultConfig)).onready=t}else r=Object.assign(Object.create(null),e.defaultConfig,r);const t=Object.create(null),o=function(){},a=r.onerror||o,n=r.debug||o,s=r.generateMessageId?void 0:Object.create(null),c=r.generateMessageId||function(e){return e.type+"#"+(s[e.type]=(s[e.type]||0)+1)},i=(...e)=>{throw new Error(e.join(" "))};let l,u;return r.worker||(r.worker=e.defaultConfig.worker),"function"===typeof r.worker&&(r.worker=r.worker()),r.worker.onmessage=function(e){e=e.data,n("worker1.onmessage",e);let o=t[e.messageId];if(!o)return e&&"sqlite3-api"===e.type&&"worker1-ready"===e.result?void(r.onready&&r.onready(u)):(o=t[e.type],o&&o.onrow?void o.onrow(e):void(r.onunhandled?r.onunhandled(arguments[0]):a("sqlite3Worker1Promiser() unhandled worker message:",e)));switch(delete t[e.messageId],e.type){case"error":return void o.reject(e);case"open":l||(l=e.dbId);break;case"close":e.dbId===l&&(l=void 0)}try{o.resolve(e)}catch(s){o.reject(s)}},u=function(){let e;1===arguments.length?e=arguments[0]:2===arguments.length?(e=Object.create(null),e.type=arguments[0],e.args=arguments[1],e.dbId=e.args.dbId):i("Invalid arguments for sqlite3Worker1Promiser()-created factory."),e.dbId||"open"===e.type||(e.dbId=l),e.messageId=c(e),e.departureTime=performance.now();const o=Object.create(null);let a;o.message=e,"exec"===e.type&&e.args&&("function"===typeof e.args.callback?(a=e.messageId+":row",o.onrow=e.args.callback,e.args.callback=a,t[a]=o):"string"===typeof e.args.callback&&i("exec callback may not be a string when using the Promise interface."));let s=new Promise((function(a,s){o.resolve=a,o.reject=s,t[e.messageId]=o,n("Posting",e.type,"message to Worker dbId="+(l||"default")+":",e),r.worker.postMessage(e)}));return a&&(s=s.finally((()=>delete t[a]))),s}},globalThis.sqlite3Worker1Promiser.defaultConfig={worker:function(){return new Worker(new URL(t.p+t.u(820),t.b),{type:void 0})},onerror:(...e)=>console.error("worker1 promiser error",...e)},sqlite3Worker1Promiser.v2=function(e){let r;"function"==typeof e?(r=e,e={}):"function"===typeof e?.onready&&(r=e.onready,delete e.onready);const t=Object.create(null);e=Object.assign(e||Object.create(null),{onready:async function(e){try{r&&await r(e),t.resolve(e)}catch(o){t.reject(o)}}});const o=new Promise((function(e,r){t.resolve=e,t.reject=r}));try{this.original(e)}catch(a){t.reject(a)}return o}.bind({original:sqlite3Worker1Promiser});sqlite3Worker1Promiser.v2,self.sqlite3Worker1Promiser;const m=b.default;var w=t(33296),v=t(61470);globalThis.sqlite3ApiConfig={warn:v.constVoid};const k=i.effect(n.SqliteFactory,c.gen((function*(){const e=yield*p.NanoIdGenerator,r=m();return n.SqliteFactory.of({createSqlite:c.gen((function*(){const t=yield*c.flatMap((0,g.getLockName)("SqliteBroadcastChannel"),h);t.onMessage=e=>{switch(e._tag){case"Exec":o=[...o,e];break;case"ExecError":case"ExecSuccess":o=w.filter(o,(r=>r.id!==e.id)),a(e);break;default:(0,v.absurd)(e)}};let o=[];const a=e=>{const r=s.get(e.id);r&&(r(e),s.delete(e.id))},s=new Map,i=yield*f.Config,l=(0,f.createRuntime)(i);c.logTrace("SqliteWeb connection lock request").pipe(c.zipRight((0,g.getLockName)("SqliteConnection")),c.flatMap((e=>c.async((t=>{navigator.locks.request(e,(()=>new Promise((()=>{t(c.promise((()=>r)))}))))})))),c.tap(c.logTrace("SqliteWeb connection lock granted")),c.flatMap((e=>c.promise((()=>e.installOpfsSAHPoolVfs({name:i.name}))).pipe(c.map((r=>({sqlite:new r.OpfsSAHPoolDb("/evolu1.db"),sqlite3:e})))))),c.tap((({sqlite:e,sqlite3:r})=>{const s=(o,a)=>c.try({try:()=>{if(o.sql===q.sql){return[{file:r.capi.sqlite3_js_db_export(e)}]}return e.exec(o.sql,{returnValue:"resultRows",rowMode:"object",bind:(0,n.valuesToSqliteValues)(o.parameters||[])})},catch:y.ensureTransferableError}).pipe((0,n.maybeLogSqliteQueryExecutionTime)(o),c.match({onSuccess:r=>{t.postMessage({_tag:"ExecSuccess",id:a,result:{rows:r,changes:e.changes()}})},onFailure:e=>{t.postMessage({_tag:"ExecError",id:a,error:e})}}),l.runSync);t.onMessage=e=>{switch(e._tag){case"Exec":s(e.query,e.id);break;case"ExecSuccess":case"ExecError":a(e);break;default:(0,v.absurd)(e)}},o.forEach((e=>{s(e.query,e.id)})),o=[]}))).pipe(c.provideService(f.Config,i),l.runPromise);const u=yield*(0,g.getLockName)("SqliteTransaction");return n.Sqlite.of({exec:r=>c.flatMap(e.nanoid,(e=>c.async((o=>{s.set(e,(e=>{switch(e._tag){case"ExecSuccess":o(c.succeed(e.result));break;case"ExecError":o(c.die(e.error))}})),t.postMessage({_tag:"Exec",id:e,query:r})})))),transaction:e=>r=>c.acquireUseRelease(c.async((r=>{navigator.locks.request(u,{mode:"last"===e?"exclusive":e},(()=>new Promise((e=>{r(c.succeed(e))}))))})),(()=>r),(r=>c.sync((()=>{"last"!==e&&r()})))),export:()=>c.flatMap(e.nanoid,(e=>c.async((r=>{s.set(e,(e=>{switch(e._tag){case"ExecSuccess":r(c.succeed(e.result.rows[0].file));break;case"ExecError":r(c.die(e.error))}})),t.postMessage({_tag:"Exec",id:e,query:q})}))))})}))})}))),h=e=>c.sync((()=>{const r=new BroadcastChannel(e),t={postMessage:e=>{r.postMessage(e),t.onMessage(e)},onMessage:v.constVoid};return r.onmessage=e=>{t.onMessage(e.data)},t})),q={sql:"export database"},S=i.succeed(o.SyncFactory,{createSync:c.sync((()=>(0,d.wrap)(new Worker(new URL(t.p+t.u(431),t.b),{type:void 0}))))});a.createDb.pipe(c.provide(i.mergeAll(n.SqliteFactory.Common.pipe(i.provide(k),i.provide(l.NanoIdGeneratorLive)),l.NanoIdGeneratorLive,s.Time.Live,S,u.SyncLockLive)),c.runSync,d.expose)}},r={};function t(o){var a=r[o];if(void 0!==a)return a.exports;var n=r[o]={exports:{}};return e[o](n,n.exports,t),n.exports}t.m=e,t.x=()=>{var e=t.O(void 0,[74,933,997],(()=>t(67726)));return e=t.O(e)},(()=>{var e=[];t.O=(r,o,a,n)=>{if(!o){var s=1/0;for(u=0;u<e.length;u++){for(var[o,a,n]=e[u],c=!0,i=0;i<o.length;i++)(!1&n||s>=n)&&Object.keys(t.O).every((e=>t.O[e](o[i])))?o.splice(i--,1):(c=!1,n<s&&(s=n));if(c){e.splice(u--,1);var l=a();void 0!==l&&(r=l)}}return r}n=n||0;for(var u=e.length;u>0&&e[u-1][2]>n;u--)e[u]=e[u-1];e[u]=[o,a,n]}})(),t.d=(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},t.f={},t.e=e=>Promise.all(Object.keys(t.f).reduce(((r,o)=>(t.f[o](e,r),r)),[])),t.u=e=>"bundle.web."+e+".js",t.miniCssF=e=>{},t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),t.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var r=t.g.document;if(!e&&r&&(r.currentScript&&(e=r.currentScript.src),!e)){var o=r.getElementsByTagName("script");o.length&&(e=o[o.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),(()=>{t.b=self.location+"";var e={726:1};t.f.i=(r,o)=>{e[r]||importScripts(t.p+t.u(r))};var r=self.webpackChunkStarpyApp=self.webpackChunkStarpyApp||[],o=r.push.bind(r);r.push=r=>{var[a,n,s]=r;for(var c in n)t.o(n,c)&&(t.m[c]=n[c]);for(s&&s(t);a.length;)e[a.pop()]=1;o(r)}})(),(()=>{var e=t.x;t.x=()=>Promise.all([74,933,997].map(t.e,t)).then(e)})();t.x()})();
//# sourceMappingURL=bundle.web.726.js.map